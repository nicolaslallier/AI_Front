image: node:20-alpine

stages:
  - install
  - validate
  - test
  - build
  - docker
  - deploy

variables:
  DOCKER_IMAGE: $CI_REGISTRY_IMAGE
  DOCKER_TAG: $CI_COMMIT_SHORT_SHA

cache:
  key: ${CI_COMMIT_REF_SLUG}
  paths:
    - node_modules/
    - .npm/

before_script:
  - apk add --no-cache make

# Install dependencies
install:
  stage: install
  script:
    - make install
  artifacts:
    paths:
      - node_modules/
    expire_in: 1 day

# Code quality validation
validate:
  stage: validate
  dependencies:
    - install
  script:
    - make validate

# Unit and component tests
test:
  stage: test
  dependencies:
    - install
  script:
    - make test
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 7 days

# E2E tests
test:e2e:
  stage: test
  dependencies:
    - install
  script:
    - make test-e2e
  artifacts:
    when: always
    paths:
      - playwright-report/
    expire_in: 7 days

# Build application
build:
  stage: build
  dependencies:
    - install
  script:
    - make build
  artifacts:
    paths:
      - dist/
    expire_in: 7 days

# Build Docker image
docker:build:
  stage: docker
  image: docker:24
  services:
    - docker:24-dind
  dependencies:
    - build
  script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - make docker-build
    - docker tag ai-front:latest $DOCKER_IMAGE:$DOCKER_TAG
    - docker tag ai-front:latest $DOCKER_IMAGE:latest
    - docker push $DOCKER_IMAGE:$DOCKER_TAG
    - docker push $DOCKER_IMAGE:latest
  only:
    - main
    - develop

# Deploy to staging
deploy:staging:
  stage: deploy
  environment:
    name: staging
    url: https://staging.example.com
  dependencies:
    - docker:build
  script:
    - make deploy-staging
  only:
    - develop

# Deploy to production
deploy:production:
  stage: deploy
  environment:
    name: production
    url: https://example.com
  dependencies:
    - docker:build
  script:
    - make deploy-production
    - make smoke-test
  only:
    - main
  when: manual

